/**
 * TarifasJDialog.java
 * © MINETUR, Government of Spain
 * This program is part of LocalGIS
 * This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
package com.geopista.app.cementerios.panel;

import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.Vector;

import javax.swing.JComboBox;
import javax.swing.JFrame;
import javax.swing.JOptionPane;

import com.geopista.app.AppContext;
import com.geopista.app.cementerios.Constantes;
import com.geopista.app.cementerios.Estructuras;
import com.geopista.protocol.administrador.dominios.DomainNode;
import com.geopista.protocol.cementerios.TarifaBean;
import com.geopista.util.ApplicationContext;

/*
 * TarifasJDialog.java
 *
 * Created on 10-jun-2011, 14:21:18
 */

/**
 *
 * @author yraton
 */
public class TarifasJDialog extends javax.swing.JDialog {

	private static final long serialVersionUID = 1L;
	private String operacion;
	private String tipo;
    private ApplicationContext aplicacion;
    private javax.swing.JFrame desktop;
    
    private TarifaBean tarifa;
    private ArrayList<TarifaBean> listaTarifasTabla;
    

    private int selectedRow= -1;
	public static final String DOBLE_CLICK="DOBLE_CLICK";

	private BotoneraAceptarCancelarJPanel botoneraAceptarCancelarJPanel;
    private ArrayList actionListeners= new ArrayList();
    private String locale;
	
	private Vector vDomainCategoria;
	private Vector vDomainTipoCalculo;
	
	private int patronCategoria = 1;
	private String patronCalculo = "1";



	private SimpleDateFormat fecha = new SimpleDateFormat("dd/MM/yyyy");

	
    /** Creates new form TarifasJDialog */
    public TarifasJDialog (JFrame desktop, String locale, String operacion,String tipo) throws Exception{
    	super(desktop);
        this.desktop= desktop;
        this.locale= locale;
        this.operacion= operacion;
        this.tipo=tipo;
        inicializar();
    }

    /** Creates new form TarifasJDialog */
    public TarifasJDialog(JFrame desktop, String locale) throws Exception{
        super(desktop);
        this.desktop= desktop;
        this.locale= locale;
        inicializar();
    }

    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */

    private void inicializar() {
    	
    	this.aplicacion = (AppContext) AppContext.getApplicationContext();
        getContentPane().setLayout(new BorderLayout());
        renombrarComponentes();
        setModal(true);

        desktop = new javax.swing.JFrame();


        tarifasJPanel = new javax.swing.JPanel();
        DatosGeneralesComunesJPanel = new javax.swing.JPanel();
        entidadJLabel = new javax.swing.JLabel();
        cementerioJLabel = new javax.swing.JLabel();
        entidadJTextField = new javax.swing.JTextField();
        cementerioJTextField = new javax.swing.JTextField();
        DatosTarifasJPanel = new javax.swing.JPanel();
        
        categoríaJLabel = new javax.swing.JLabel();
        categoríaJComboBox = new javax.swing.JComboBox();
        conceptoJLabel = new javax.swing.JLabel();
        conceptoJTextField = new javax.swing.JTextField();
        tipoCalculoJLabel = new javax.swing.JLabel();
        tipoCalculoJComboBox = new javax.swing.JComboBox();
        precioLabel = new javax.swing.JLabel();
        precioJTextField = new javax.swing.JTextField();

        setSize(820, 520);
        
        tarifasJPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());
   
        DatosGeneralesComunesJPanel.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        DatosGeneralesComunesJPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        entidadJLabel.setText("Entidad");
        DatosGeneralesComunesJPanel.add(entidadJLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 20, -1, -1));

        cementerioJLabel.setText("Cementerio");
        DatosGeneralesComunesJPanel.add(cementerioJLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 40, -1, -1));

        entidadJTextField.setText("");
        DatosGeneralesComunesJPanel.add(entidadJTextField, new org.netbeans.lib.awtextra.AbsoluteConstraints(80, 10, 780, -1));

        cementerioJTextField.setText("");
        DatosGeneralesComunesJPanel.add(cementerioJTextField, new org.netbeans.lib.awtextra.AbsoluteConstraints(80, 40, 780, -1));

        tarifasJPanel.add(DatosGeneralesComunesJPanel, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, 880, 70));

        //PANEL TARIFAS
        listaTarifasTabla = new ArrayList<TarifaBean>();
        
        DatosTarifasJPanel.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        DatosTarifasJPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());


        categoríaJLabel.setText("Categoría");
        DatosTarifasJPanel.add(categoríaJLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(18, 22, -1, -1));

        //Dominios tipo unidad enterramiento
        
        //cargarmos las estructuras..
        while (!Estructuras.isCargada()){
            if (!Estructuras.isIniciada()) Estructuras.cargarEstructuras();
            try {Thread.sleep(500);}catch(Exception e){}
        }

        vDomainCategoria = Estructuras.getListaCombosSorted(locale);
        categoríaJComboBox = new JComboBox(vDomainCategoria);
        for (int i = 0; i < vDomainCategoria.size(); i++) {
  		DomainNode node = (DomainNode) vDomainCategoria.get(i);
  		if (node.getPatron().equalsIgnoreCase(String.valueOf(getPatronCategoria()))){
  			categoríaJComboBox.setSelectedIndex(i);
  		}
  	}
        
        
        categoríaJComboBox.addActionListener(new java.awt.event.ActionListener(){
  		public void actionPerformed(ActionEvent e){
  			JComboBox cb = (JComboBox)e.getSource();
  			DomainNode dNode= (DomainNode) cb.getSelectedItem();
  			 int patron = Integer.parseInt(dNode.getPatron());
  			 if (patron != 0){
  				 setPatronCategoria(patron);
  			 }
  		}
       });
        

        vDomainTipoCalculo = Estructuras.getListaComboConcesiones(locale);
        tipoCalculoJComboBox = new JComboBox(vDomainTipoCalculo);
        for (int i = 0; i < vDomainTipoCalculo.size(); i++) {
  		DomainNode node = (DomainNode) vDomainTipoCalculo.get(i);
	  		if (node.getPatron().equalsIgnoreCase(String.valueOf(getPatronCalculo()))){
	  			tipoCalculoJComboBox.setSelectedIndex(i);
	  		}
        }
        
        tipoCalculoJComboBox.addActionListener(new java.awt.event.ActionListener(){
  		public void actionPerformed(ActionEvent e){
  			JComboBox cb = (JComboBox)e.getSource();
  			DomainNode dNode= (DomainNode) cb.getSelectedItem();
//  			 int patron = Integer.parseInt(dNode.getPatron());
//  			 if (patron != 0){
  			String patron = dNode.getPatron();
  	  		if (patron != "0"){
  				 setPatronCalculo(patron);
  			 }
  		}
  	}); 
        
        
        DatosTarifasJPanel.add(categoríaJComboBox, new org.netbeans.lib.awtextra.AbsoluteConstraints(83, 19, 189, -1));

        conceptoJLabel.setText("Concepto ");
        DatosTarifasJPanel.add(conceptoJLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(18, 60, -1, -1));

        conceptoJTextField.setText(" ");
        DatosTarifasJPanel.add(conceptoJTextField, new org.netbeans.lib.awtextra.AbsoluteConstraints(77, 57, 775, -1));

        tipoCalculoJLabel.setText("Tipo Calculo");
        DatosTarifasJPanel.add(tipoCalculoJLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(307, 22, -1, -1));

        DatosTarifasJPanel.add(tipoCalculoJComboBox, new org.netbeans.lib.awtextra.AbsoluteConstraints(382, 19, 189, -1));

        precioLabel.setText("Precio");
        DatosTarifasJPanel.add(precioLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(609, 22, -1, -1));

        precioJTextField.setText(" ");
        DatosTarifasJPanel.add(precioJTextField, new org.netbeans.lib.awtextra.AbsoluteConstraints(648, 19, 116, -1));

        tarifasJPanel.add(DatosTarifasJPanel, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 102, 870, 90));
        
        botoneraAceptarCancelarJPanel= new BotoneraAceptarCancelarJPanel();
        botoneraAceptarCancelarJPanel.addActionListener(new java.awt.event.ActionListener(){
          public void actionPerformed(ActionEvent e){
				botoneraAceptarCancelarJPanel_actionPerformed();
			}
			});

        
        addWindowListener(new java.awt.event.WindowAdapter() {
        	public void windowClosing(java.awt.event.WindowEvent evt) {
        		exitForm(evt);
          }
      });
        
        getContentPane().add(tarifasJPanel, java.awt.BorderLayout.CENTER);
        getContentPane().add(botoneraAceptarCancelarJPanel, java.awt.BorderLayout.SOUTH);
            
        pack();

        }


        public void renombrarComponentes(){
//          try{datosGeneralesComunesJPanel.setBorder(new javax.swing.border.TitledBorder(aplicacion.getI18nString("cementerio.datosGenerales.tag1")));}catch(Exception e){}
      }

      
      public void addActionListener(ActionListener l) {
          this.actionListeners.add(l);
      }

      public void removeActionListener(ActionListener l) {
          this.actionListeners.remove(l);
      }

      
      private void fireActionPerformed() {
          for (Iterator i = actionListeners.iterator(); i.hasNext();) {
              ActionListener l = (ActionListener) i.next();
              l.actionPerformed(new ActionEvent(this, 0, null));
          }
      }

      
      /* Método que abre una ventana de confirmacion sobre la operacion que se esta llevando a cabo
      */
     private boolean confirmOption(){
         int ok= -1;
         ok= JOptionPane.showConfirmDialog(this, aplicacion.getI18nString("cementerio.optionpane.tag1"), aplicacion.getI18nString("cementerio.optionpane.tag2"), JOptionPane.YES_NO_OPTION);
         if (ok == JOptionPane.NO_OPTION){
             return false;
         }
         return true;
     }

     private void exitForm(java.awt.event.WindowEvent evt) {
    	 setTarifa(null);
         fireActionPerformed();
     }

      
      public void botoneraAceptarCancelarJPanel_actionPerformed(){
          if((!botoneraAceptarCancelarJPanel.aceptarPressed()) ||
             (botoneraAceptarCancelarJPanel.aceptarPressed() && operacion.equalsIgnoreCase(Constantes.OPERACION_MODIFICAR)?!confirmOption():false)){
          	 tarifa= null;
          }
          else{
          	actualizarDatosTarifa(tarifa);
          }
          fireActionPerformed();
      }
      
      
      public void actualizarDatosTarifa(TarifaBean tarifa){
          
    	  	if (tarifa==null) return;

    	  	tarifa.setEntidad(entidadJTextField.getText().trim());
    	  	tarifa.setNombreCementerio(cementerioJTextField.getText().trim());
    	  	
    	  	tarifa.setConcepto(conceptoJTextField.getText().trim());
    	  	
    	  	String precioStr = precioJTextField.getText().trim();

    	  	tarifa.setPrecio(precioJTextField.getText().trim());
    	  	
    	  	tarifa.setTipo_unidad(getPatronCategoria());
    	  	tarifa.setTipo_calculo(getPatronCalculo());
    	  	
    	    setTarifa(tarifa);
    	      
    	  }
    	  
    	  
	  public void loadDatosTarifa (TarifaBean tarifaElem, boolean editable){
	  	
	  	if (tarifaElem == null ) return ;
	  
    	    //cargarmos las estructuras..
	    while (!Estructuras.isCargada()){
	        if (!Estructuras.isIniciada()) Estructuras.cargarEstructuras();
	        try {Thread.sleep(500);}catch(Exception e){}
	    }
	    
       for (int i = 0; i < vDomainCategoria.size(); i++) {
	    	DomainNode node = (DomainNode) vDomainCategoria.get(i);
			if (node.getPatron().equalsIgnoreCase(String.valueOf(tarifaElem.getTipo_unidad()))){
				categoríaJComboBox.setSelectedIndex(i);
				setPatronCategoria(tarifaElem.getTipo_unidad());
			}
	      }
	       categoríaJComboBox.setEnabled(editable);
	       
	      for (int i = 0; i < vDomainTipoCalculo.size(); i++) {
			DomainNode node = (DomainNode) vDomainTipoCalculo.get(i);
			if (node.getPatron().equalsIgnoreCase(String.valueOf(tarifaElem.getTipo_calculo()))){
				tipoCalculoJComboBox.setSelectedIndex(i);
			}
	      }
  
	    tipoCalculoJComboBox.setEnabled(editable);
	  }
	  
    	 
	/**
	 * Método que carga en el panel los datos generales del bloque
	 * @param bloque a cargar en el panel
	 */
	public void load(TarifaBean tarifaElem, boolean editable) {
		if (tarifaElem == null)
			return;
		
	  	entidadJTextField.setText(tarifaElem.getEntidad() != null ? tarifaElem.getEntidad() : "" );
	  	entidadJTextField.setEditable(false);
	  	
	  	cementerioJTextField.setText(tarifaElem.getNombreCementerio()!= null ? tarifaElem.getNombreCementerio() : "");
	  	cementerioJTextField.setEditable(false);
		
		setTarifa(tarifaElem);
		if(operacion == null) return;

    	loadDatosTarifa(tarifaElem, editable);

	    precioJTextField.setText(tarifaElem.getPrecio()!= null ? tarifaElem.getPrecio() : "0" );
	    precioJTextField.setEditable(editable);
	    
	    conceptoJTextField.setText(tarifaElem.getConcepto()!= null ? tarifaElem.getConcepto() : "");
	    conceptoJTextField.setEditable(editable);
	    
	}

        
    public TarifaBean getTarifa() {
		return tarifa;
	}

	public void setTarifa(TarifaBean tarifa) {
		this.tarifa = tarifa;
	}


    public int getPatronCategoria() {
		return patronCategoria;
	}

	public void setPatronCategoria(int patronCategoria) {
		this.patronCategoria = patronCategoria;
	}
	
    public String getPatronCalculo() {
		return patronCalculo;
	}

	public void setPatronCalculo(String patronCalculo) {
		this.patronCalculo = patronCalculo;
	}
	
    private javax.swing.JPanel DatosGeneralesComunesJPanel;
    private javax.swing.JPanel DatosTarifasJPanel;
    private javax.swing.JLabel cementerioJLabel;
    private javax.swing.JLabel entidadJLabel;
    private javax.swing.JTextField cementerioJTextField;
    private javax.swing.JTextField entidadJTextField;
    private javax.swing.JPanel tarifasJPanel;

    

    private javax.swing.JComboBox categoríaJComboBox;
    private javax.swing.JLabel categoríaJLabel;
    private javax.swing.JLabel conceptoJLabel;
    private javax.swing.JTextField conceptoJTextField;
    private javax.swing.JTextField precioJTextField;
    private javax.swing.JLabel precioLabel;
    private javax.swing.JComboBox tipoCalculoJComboBox;
    private javax.swing.JLabel tipoCalculoJLabel;
    
    // End of variables declaration
    

    
}
